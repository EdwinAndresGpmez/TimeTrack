name: TimeTrack CI/CD

# Se ejecuta en cada Push o PR a main
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # Permite ejecutarlo manualmente desde GitHub si es necesario
  workflow_dispatch:

jobs:
  # ------------------------------------------------------------------
  # JOB 1: CALIDAD DE CÃ“DIGO (LINTING) - Falla rÃ¡pido y barato
  # Usamos Ruff (Backend) y ESLint (Frontend)
  # ------------------------------------------------------------------
  code-quality:
    name: ðŸ” Calidad de CÃ³digo (Linting)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- BACKEND (RUFF) ---
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ruff (Linter UltrarrÃ¡pido)
        run: pip install ruff

      - name: Analizar Backend con Ruff
        run: |
          # Escanea todos los microservicios
          ruff check ./microservices
          # Verifica formato (Black compatible)
          ruff format --check ./microservices

      # --- FRONTEND (ESLINT) ---
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Install Frontend Deps
        working-directory: ./frontend
        run: npm ci

      - name: Analizar Frontend con ESLint
        working-directory: ./frontend
        run: npm run lint
        # Nota: AsegÃºrate de tener el script "lint": "eslint ." en tu package.json

  # ------------------------------------------------------------------
  # JOB 2: CONSTRUCCIÃ“N Y PRUEBAS UNITARIAS (PYTEST)
  # Se ejecuta solo si la calidad de cÃ³digo pasÃ³.
  # ------------------------------------------------------------------
  build-and-test:
    name: ðŸ—ï¸ Build & Unit Tests (Docker)
    needs: code-quality # Espera a que pase el linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Creamos el .env dummy (Igual que tenÃ­as, es vital)
      - name: Create dummy .env file
        run: |
          echo "DB_NAME=test_db" >> .env
          echo "DB_USER=postgres" >> .env
          echo "DB_PASSWORD=postgres" >> .env
          echo "DB_HOST=db" >> .env
          echo "DB_PORT=5432" >> .env
          echo "SECRET_KEY=django-insecure-test-key-for-ci-pipeline" >> .env
          echo "DEBUG=True" >> .env
          echo "ALLOWED_HOSTS=localhost,127.0.0.1,auth-ms,patients-ms,appointments-ms" >> .env
          echo "REDIS_URL=redis://redis:6379/0" >> .env
          echo "DATABASE_URL=postgres://postgres:postgres@db:5432/test_db" >> .env
          echo "VITE_API_URL=http://localhost:8080/api" >> .env

      # Construimos las imÃ¡genes
      - name: Build Docker Services
        run: docker compose build

      # Levantamos base de datos y servicios necesarios en segundo plano
      # Usamos --wait para asegurar que la DB estÃ© lista antes de testear
      - name: Start Services
        run: docker compose up -d --wait db redis

      # ------------------------------------------------------------------
      # EJECUCIÃ“N DE PRUEBAS UNITARIAS (PYTEST)
      # Ejecutamos pytest DENTRO del contenedor para asegurar el entorno real.
      # ------------------------------------------------------------------
      
      - name: ðŸ§ª Test Auth MS
        run: docker compose run --rm auth-ms pytest

      - name: ðŸ§ª Test Patients MS
        run: docker compose run --rm patients-ms pytest

      - name: ðŸ§ª Test Appointments MS (Reglas CrÃ­ticas)
        run: docker compose run --rm appointments-ms pytest

      - name: ðŸ§ª Test Professionals MS
        run: docker compose run --rm professionals-ms pytest

      - name: ðŸ§ª Test Schedule MS
        run: docker compose run --rm schedule-ms pytest

      # Limpieza final
      - name: Stop Containers
        if: always()
        run: docker compose down